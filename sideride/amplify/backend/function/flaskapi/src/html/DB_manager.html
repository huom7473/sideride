<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>DB_manager API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>DB_manager</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from datetime import datetime, date, timedelta
import mysql.connector as ms
from flask import json, jsonify
from Ride_manager import *

# Static global 
CONN_FAILURE = &#34;Connection failed&#34;
CONN_SUCCESS = &#34;Connection established&#34;

# for CORS: https://cors-anywhere.herokuapp.com/ before the hostname

default_config = {
    &#39;user&#39;: &#39;SideRideProject&#39;,
    &#39;password&#39;: &#39;SideRideProject130*&#39;,
    &#39;host&#39;: &#39;database-side-ride-project.ch9vjbvoh8tk.us-east-2.rds.amazonaws.com&#39;,
    &#39;database&#39;: &#39;SideRideSchema&#39;,
    &#39;raise_on_warnings&#39;: True
}

class Database:
    &#34;&#34;&#34;
    A class used to interact with the backend database and serve results to the frontend

    Attributes
    ---------
    config : dict
        a formatted dictionary holding the required parameters to establish a DB connection
    
    connection : mysql.connector.MySQLConnection 
        acts as a handle (i.e. file handle) to access the mySQL database after establishing connection
    
    cursor : mysql.connector.MySQLCursor
        responsible for executing specified queries on the database and buffering fetched results 
    

    Methods
    --------

    get_handle()
        returns the handle for the connected instance of the database
    
    connect_to_db()
        tries to establish a connection to the database using supplied config file
    
    create_ride(params)
        adds an entry to the DB signifying the new ride with the given params 
        
    find_rides_(params)
        serves user list of rides meeting supplied params 
    
    add_driver()
        logs new driver into backend table 

    add_rider()
        logs new rider into backend table (called when user requests to book a seat in a ride)
    
    accept_ride()
        sets user&#39;s status for ride to ACCEPTED

    deny_ride()
        sets user&#39;s status for ride to DENIED
    
    update_seatCount()
        decrement seat count for given ride if possible
    
    cleanupRides()
        prune all rides that start before the current date 
    
    delete_riders()
        removes all entries from Riders table
    
    def find_rides()
        finds all rides matching given search parameters

    def format_results()
        formats SQL output into frotend-friendly form 
    
    def myrides()
        finds all rides for current user (both driving and riding)
    
    &#34;&#34;&#34;
    #get rid of return none
    def __init__(self, config=default_config):
        &#34;&#34;&#34;
        Parameters
        ----------
        config : dict
            A formatted dictionary holding the required parameters to establish a DB connection
            If none specified, defaults to a pre-tested config in order to connect to a mySQL DB 
    
        connection : mysql.connector.MySQLConnection 
            Acts as a handle (i.e. file handle) to access the mySQL database after establishing connection
    
        cursor : mysql.connector.MySQLCursor
            Responsible for executing specified queries on the database and buffering fetched results 
        
        &#34;&#34;&#34;
        self.config = config
        self.connection = None
        self.cursor = None

    def get_handle(self) -&gt; ms:
        &#34;&#34;&#34;
        Returns handle to the DB instance 
        &#34;&#34;&#34;
        return self.connection

    def connect_to_db(self) -&gt; str:
        &#34;&#34;&#34;
        Uses supplied config file to connect to a mySQL database, initialize the cursor, and return the handle
        for the connection to user 

        Returns a static message CONN_FAILURE on failure to establish connection
        &#34;&#34;&#34;
        try:
            self.connection = ms.connect(**self.config) 
            self.cursor = self.connection.cursor()    
            return self.get_handle() 
        except:
            return CONN_FAILURE
    
    def create_ride(self, ride:Ride) -&gt; bool:
        &#34;&#34;&#34;
        Creates the specified ride and adds it to the MasterRides table in the backend DB

        Returns True if ride was succesfully added, False if not 

        Parameters
        -------- 
        
        ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.

        &#34;&#34;&#34;

        params = ride.getAll()
        
        insert_stmt = (
            &#34;INSERT INTO MasterRides &#34;
            &#34;VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NULL, %s, %s)&#34;
        )
        
        values = (
            params[&#39;driver&#39;], params[&#39;from&#39;], params[&#39;to&#39;], params[&#39;fromLat&#39;], params[&#39;fromLng&#39;],
            params[&#39;make&#39;], params[&#39;plate&#39;], params[&#39;datetime&#39;], 
            params[&#39;price&#39;], params[&#39;seats&#39;], params[&#39;model&#39;], params[&#39;toLat&#39;], params[&#39;toLng&#39;]
            )
        
        # This catches improper insertions 
        try:
            self.cursor.execute(insert_stmt,values)
            id = self.cursor.lastrowid
            ride.set_ride_id(id)
            self.connection.commit()
            return True
            #GET RID OF THIS LINE AT 130
        except ms.Error as err:
            return err.msg
    
    def add_driver(self, ride:Ride) -&gt; bool:
        &#34;&#34;&#34;
            Adds the driver as a &#34;user of the ride&#34; to the secondary Riders table with following schema:
            
            ride_id | username | status | is_driver 

            Returns True on success, False on failure. 

            Parameters
            -------- 
        
            ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.
        &#34;&#34;&#34;
        params = ride.getAll()
        id = ride.get_ride_id()
        insert_stmt = (
            &#34;INSERT INTO Riders &#34;
            &#34;VALUES (%s, %s, %s, %s)&#34;
        )
        
        values = (
            id, params[&#39;driver&#39;], &#39;ACCEPTED&#39;, True
            )
        
        # This catches improper insertions 
        try:
            self.cursor.execute(insert_stmt,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return err.msg

    def add_rider(self, ride_id, rider_username):
        &#34;&#34;&#34;
            Called from the &#34;book seat&#34; button, add the user to the requested ride 

            Takes in the ride_id and username, adds entry into Riders table

            Returns True on success, False on failure 

            Parameters
            --------
            ride_id: an integer describing a unique ride 

            rider_username: currently logged in username 

        &#34;&#34;&#34;
        # First check that this rider is not already part of the specific ride 
        # Return False right away if they are 
        # Otherwise add entry 

        insert_stmt = (
            &#34;INSERT INTO Riders &#34;
            &#34;VALUES (%s, %s, %s, %s)&#34;
        )
        
        values = (
            ride_id, rider_username, &#39;PENDING&#39;, False
            )
        
        try:
            self.cursor.execute(insert_stmt,values)
            self.connection.commit()
            return (0, &#34;Updated ride with new rider&#34;)
        except ms.Error as err:
            # Code 1062 = failed insertion due to duplicate primary key
            if err.errno == 1062: return (1062,err.msg)

    def accept_ride(self, ride_id, user):
        &#34;&#34;&#34;
            Changes status of rider from PENDING-&gt;ACCEPTED
            Decrement seat count for the ride by 1 

            Parameters
            --------
            ride_id: an integer describing a unique ride 

            user: currently logged in username 

        &#34;&#34;&#34;
        # First check if the ride has seats left, return false right away if it doesn&#39;t

        query = (
            &#34;SELECT seats FROM MasterRides WHERE ride_id = %s &#34;
        )
        i = (ride_id,)
        self.cursor.execute(query,i)
        rows = self.cursor.fetchall()
        results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rows:
            results.append(dict(zip(headers,record)))
        
        results = results[0]
        if results[&#39;seats&#39;] &lt; 1:
            return (1, &#34;No space left in ride&#34;)

        update = (
            &#34;UPDATE Riders SET status = &#39;ACCEPTED&#39; WHERE ride_id = %s AND username = %s &#34;
        )

        values = (ride_id,user)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
        except ms.Error as err:
            return (1,err.msg)

        # Then UPDATE MasterRides by decrementing seat count for given ride_id 
        msg =  self.update_seatCount(ride_id)
        if msg == True: return (0,True)
        else: return (0,msg)

    def update_seatCount(self,ride_id):
        &#34;&#34;&#34;
            Decrements seat count for given ride id

            Parameters
            -----------
            ride_id: an integer describing a unique ride 
        &#34;&#34;&#34;

        update = (
            &#34;UPDATE MasterRides SET seats = seats-1 WHERE ride_id = %s &#34;
        )

        values = (ride_id,)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return err.msg
    
    def deny_ride(self, ride_id, user):
        &#34;&#34;&#34;
            Changes status of rider from PENDING-&gt;DENIED
            
            Parameters
            --------
            ride_id: an integer describing a unique ride 

            user: currently logged in username 
        &#34;&#34;&#34;

        update = (
            &#34;UPDATE Riders SET status = &#39;DENIED&#39; WHERE ride_id = %s AND username = %s &#34;
        )

        values = (ride_id,user)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return (err.msg)
    
    def cleanup_rides(self):
        &#34;&#34;&#34;
        Removes all entries from MasterRides with trip start dates that occur before current date  


        &#34;&#34;&#34;
        queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
        queryB = (&#34;&#34;&#34;DELETE FROM MasterRides WHERE date &lt; curdate()&#34;&#34;&#34;)
        queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
        

        try:
            self.cursor.execute(queryA)
            self.cursor.execute(queryB)
            self.cursor.execute(queryC)
            self.connection.commit()
            return True
        except ms.Error as err:
            # Error code for attempting an unsafe update 
            if err.errno == 1175:
                return err.msg
            else: return err.msg

    def delete_riders(self):
        &#34;&#34;&#34;
        Removes all entries from Rides


        &#34;&#34;&#34;
        queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
        queryB = (&#34;&#34;&#34;DELETE FROM Riders&#34;&#34;&#34;)
        queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
        

        try:
            self.cursor.execute(queryA)
            self.cursor.execute(queryB)
            self.cursor.execute(queryC)
            self.connection.commit()
            return True
        except ms.Error as err:
            # Error code for attempting an unsafe update 
            if err.errno == 1175:
                return err.msg
            else: return err.msg


    
    def find_rides(self, params) -&gt; dict:
        &#34;&#34;&#34;
        Currently fetches all rides that occur on the specified date from the database
        Converts result into JSON format for easy processing in front end
        Returns an empty list if no rides found for the given date 

        Parameters
        --------

        params : dict
            The user-specified set of params on which to query for
        &#34;&#34;&#34;
        
        query = (
            &#34;&#34;&#34;SELECT *, 
                (
                3959 * acos (
                cos ( radians(%(fromLat)s) )
                * cos( radians( fromLat ) )
                * cos( radians( fromLng ) - radians(%(fromLng)s))
                + sin ( radians(%(fromLat)s) )
                * sin( radians( fromLat ) ))
                ) AS fromDistance,
                (
                3959 * acos (
                cos ( radians(%(toLat)s) )
                * cos( radians( toLat ) )
                * cos( radians( toLng ) - radians(%(toLng)s))
                + sin ( radians(%(toLat)s) )
                * sin( radians( toLat ) ))
                ) AS toDistance,
                DATEDIFF(date, %(date)s) AS timeDelta
            FROM MasterRides
            HAVING fromDistance &lt; 20 AND toDistance &lt; 20 AND timeDelta &gt;= 0
            ORDER BY timeDelta, fromDistance, toDistance
            LIMIT 0 , 20&#34;&#34;&#34;
        )
        
        try:
            self.cursor.execute(query, params)     # must pass params as tuples, hence (x,) format
            rows = self.cursor.fetchall()
        except ms.Error as err:
            return err.msg

        # Now convert SQL output into JSON for frontend 
        results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rows:
            results.append(dict(zip(headers,record)))
        

        return self.format_results(results)
    
    def format_results(self, results):
        &#34;&#34;&#34;
            Formats date time of SQL output 
        &#34;&#34;&#34;
        #separates datetime objects into date and time key values
        for result in results:
            dtime = result[&#39;date&#39;]
            result.pop(&#39;date&#39;)
            result[&#39;date&#39;] = dtime.strftime(&#39;%Y-%m-%d&#39;)
            result[&#39;time&#39;] = dtime.strftime(&#39;%H:%M:%S&#39;)
        
        return results

    def myrides(self, username):
        &#34;&#34;&#34;
            Displays all rides associated with given username 

            Parameters
            ----------
            username: the currently logged in username 
        &#34;&#34;&#34;
        # First try to grab all riders that are associated with current driver&#39;s rides 
        driver_query = (
            &#34;&#34;&#34;SELECT ride_id, username, status FROM Riders
                WHERE ride_id IN (
                SELECT ride_id FROM MasterRides
                WHERE driver_username = %s)
                AND is_driver = 0&#34;&#34;&#34;
        )

        value = (username,)
        
        try:
            self.cursor.execute(driver_query, value)     # must pass params as tuples, hence (x,) format
            driver_rows = self.cursor.fetchall()
        except:
            return &#34;Failed to execute my rides querys&#34;

        # Convert data into format for frontend
        driver_results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in driver_rows:
            driver_results.append(dict(zip(headers,record)))

        # Then execute the query for riders

        rider_query = (
            &#34;&#34;&#34;SELECT * FROM MasterRides 
                INNER JOIN Riders ON
                MasterRides.ride_id=Riders.ride_id
                WHERE Riders.username = %s
                ORDER by MasterRides.date&#34;&#34;&#34;
        )

        self.cursor.execute(rider_query, value)
        rider_rows = self.cursor.fetchall()
        
        # Else convert SQL output into dict for frontend 
        rider_results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rider_rows:
            rider_results.append(dict(zip(headers,record)))
        
        return {&#39;my_passengers&#39;: driver_results, &#39;rides i am part of&#39;: rider_results}

    

# params = {&#39;from&#39;:&#39;Area 51, NV, USA&#39;, &#39;to&#39;:&#39;Area 51, NV, USA&#39;, &#39;fromLat&#39;: &#39;37.2431&#39;, &#39;fromLng&#39;: &#39;-115.793&#39;, 
#  &#39;datetime&#39;:&#39;2021-12-12 12:00:00&#39;,&#39;toLat&#39;: &#39;34.0195&#39;, &#39;toLng&#39;: &#39;-118.491&#39;, &#39;price&#39;:&#39;12&#39;, &#39;seats&#39;:&#39;5&#39;, &#39;make&#39;:&#39;Toy&#39;,
#  &#39;model&#39;:&#39;woo&#39;, &#39;plate&#39;:&#39;SDFSADF&#39;, &#39;driver&#39;:&#39;kuroodi&#39;}

# test_config = {
#     &#39;user&#39;: &#39;SideRideProject&#39;,
#     &#39;password&#39;: &#39;SideRideProject130*&#39;,
#     &#39;host&#39;: &#39;database-side-ride-project.ch9vjbv.oh8tk.us-east-2.rds.amazonaws.com&#39;,
#     &#39;database&#39;: &#39;SideRideSchemaTest&#39;,
#     &#39;raise_on_warnings&#39;: True
# }
db_handle = Database()
y = db_handle.connect_to_db()

if y == CONN_FAILURE:
    print(&#34;failed to connect&#34;)

# print(db_handle.accept_ride(&#39;81&#39;,&#39;kuroodi&#39;))
# print(db_handle.create_ride(Ride(params)))
# print(db_handle.update_seatCount(&#39;22&#39;))

# print(db_handle.find_rides(params))



# values = {&#39;id&#39;:&#39;1&#39;, &#39;seats&#39;: &#34;5&#34;, &#39;to&#39;: &#34;Los Angeles&#34;}

# x = db_handle.find_rides(params)

# print(x)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="DB_manager.Database"><code class="flex name class">
<span>class <span class="ident">Database</span></span>
<span>(</span><span>config={'user': 'SideRideProject', 'password': 'SideRideProject130*', 'host': 'database-side-ride-project.ch9vjbvoh8tk.us-east-2.rds.amazonaws.com', 'database': 'SideRideSchema', 'raise_on_warnings': True})</span>
</code></dt>
<dd>
<div class="desc"><p>A class used to interact with the backend database and serve results to the frontend</p>
<h2 id="attributes">Attributes</h2>
<dl>
<dt><strong><code>config</code></strong> :&ensp;<code>dict</code></dt>
<dd>a formatted dictionary holding the required parameters to establish a DB connection</dd>
<dt><strong><code>connection</code></strong> :&ensp;<code>mysql.connector.MySQLConnection </code></dt>
<dd>acts as a handle (i.e. file handle) to access the mySQL database after establishing connection</dd>
<dt><strong><code>cursor</code></strong> :&ensp;<code>mysql.connector.MySQLCursor</code></dt>
<dd>responsible for executing specified queries on the database and buffering fetched results</dd>
</dl>
<h2 id="methods">Methods</h2>
<p>get_handle()
returns the handle for the connected instance of the database</p>
<p>connect_to_db()
tries to establish a connection to the database using supplied config file</p>
<p>create_ride(params)
adds an entry to the DB signifying the new ride with the given params </p>
<p>find_rides_(params)
serves user list of rides meeting supplied params </p>
<p>add_driver()
logs new driver into backend table </p>
<p>add_rider()
logs new rider into backend table (called when user requests to book a seat in a ride)</p>
<p>accept_ride()
sets user's status for ride to ACCEPTED</p>
<p>deny_ride()
sets user's status for ride to DENIED</p>
<p>update_seatCount()
decrement seat count for given ride if possible</p>
<p>cleanupRides()
prune all rides that start before the current date </p>
<p>delete_riders()
removes all entries from Riders table</p>
<p>def find_rides()
finds all rides matching given search parameters</p>
<p>def format_results()
formats SQL output into frotend-friendly form </p>
<p>def myrides()
finds all rides for current user (both driving and riding)</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>config</code></strong> :&ensp;<code>dict</code></dt>
<dd>A formatted dictionary holding the required parameters to establish a DB connection
If none specified, defaults to a pre-tested config in order to connect to a mySQL DB</dd>
<dt><strong><code>connection</code></strong> :&ensp;<code>mysql.connector.MySQLConnection </code></dt>
<dd>Acts as a handle (i.e. file handle) to access the mySQL database after establishing connection</dd>
<dt><strong><code>cursor</code></strong> :&ensp;<code>mysql.connector.MySQLCursor</code></dt>
<dd>Responsible for executing specified queries on the database and buffering fetched results</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Database:
    &#34;&#34;&#34;
    A class used to interact with the backend database and serve results to the frontend

    Attributes
    ---------
    config : dict
        a formatted dictionary holding the required parameters to establish a DB connection
    
    connection : mysql.connector.MySQLConnection 
        acts as a handle (i.e. file handle) to access the mySQL database after establishing connection
    
    cursor : mysql.connector.MySQLCursor
        responsible for executing specified queries on the database and buffering fetched results 
    

    Methods
    --------

    get_handle()
        returns the handle for the connected instance of the database
    
    connect_to_db()
        tries to establish a connection to the database using supplied config file
    
    create_ride(params)
        adds an entry to the DB signifying the new ride with the given params 
        
    find_rides_(params)
        serves user list of rides meeting supplied params 
    
    add_driver()
        logs new driver into backend table 

    add_rider()
        logs new rider into backend table (called when user requests to book a seat in a ride)
    
    accept_ride()
        sets user&#39;s status for ride to ACCEPTED

    deny_ride()
        sets user&#39;s status for ride to DENIED
    
    update_seatCount()
        decrement seat count for given ride if possible
    
    cleanupRides()
        prune all rides that start before the current date 
    
    delete_riders()
        removes all entries from Riders table
    
    def find_rides()
        finds all rides matching given search parameters

    def format_results()
        formats SQL output into frotend-friendly form 
    
    def myrides()
        finds all rides for current user (both driving and riding)
    
    &#34;&#34;&#34;
    #get rid of return none
    def __init__(self, config=default_config):
        &#34;&#34;&#34;
        Parameters
        ----------
        config : dict
            A formatted dictionary holding the required parameters to establish a DB connection
            If none specified, defaults to a pre-tested config in order to connect to a mySQL DB 
    
        connection : mysql.connector.MySQLConnection 
            Acts as a handle (i.e. file handle) to access the mySQL database after establishing connection
    
        cursor : mysql.connector.MySQLCursor
            Responsible for executing specified queries on the database and buffering fetched results 
        
        &#34;&#34;&#34;
        self.config = config
        self.connection = None
        self.cursor = None

    def get_handle(self) -&gt; ms:
        &#34;&#34;&#34;
        Returns handle to the DB instance 
        &#34;&#34;&#34;
        return self.connection

    def connect_to_db(self) -&gt; str:
        &#34;&#34;&#34;
        Uses supplied config file to connect to a mySQL database, initialize the cursor, and return the handle
        for the connection to user 

        Returns a static message CONN_FAILURE on failure to establish connection
        &#34;&#34;&#34;
        try:
            self.connection = ms.connect(**self.config) 
            self.cursor = self.connection.cursor()    
            return self.get_handle() 
        except:
            return CONN_FAILURE
    
    def create_ride(self, ride:Ride) -&gt; bool:
        &#34;&#34;&#34;
        Creates the specified ride and adds it to the MasterRides table in the backend DB

        Returns True if ride was succesfully added, False if not 

        Parameters
        -------- 
        
        ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.

        &#34;&#34;&#34;

        params = ride.getAll()
        
        insert_stmt = (
            &#34;INSERT INTO MasterRides &#34;
            &#34;VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NULL, %s, %s)&#34;
        )
        
        values = (
            params[&#39;driver&#39;], params[&#39;from&#39;], params[&#39;to&#39;], params[&#39;fromLat&#39;], params[&#39;fromLng&#39;],
            params[&#39;make&#39;], params[&#39;plate&#39;], params[&#39;datetime&#39;], 
            params[&#39;price&#39;], params[&#39;seats&#39;], params[&#39;model&#39;], params[&#39;toLat&#39;], params[&#39;toLng&#39;]
            )
        
        # This catches improper insertions 
        try:
            self.cursor.execute(insert_stmt,values)
            id = self.cursor.lastrowid
            ride.set_ride_id(id)
            self.connection.commit()
            return True
            #GET RID OF THIS LINE AT 130
        except ms.Error as err:
            return err.msg
    
    def add_driver(self, ride:Ride) -&gt; bool:
        &#34;&#34;&#34;
            Adds the driver as a &#34;user of the ride&#34; to the secondary Riders table with following schema:
            
            ride_id | username | status | is_driver 

            Returns True on success, False on failure. 

            Parameters
            -------- 
        
            ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.
        &#34;&#34;&#34;
        params = ride.getAll()
        id = ride.get_ride_id()
        insert_stmt = (
            &#34;INSERT INTO Riders &#34;
            &#34;VALUES (%s, %s, %s, %s)&#34;
        )
        
        values = (
            id, params[&#39;driver&#39;], &#39;ACCEPTED&#39;, True
            )
        
        # This catches improper insertions 
        try:
            self.cursor.execute(insert_stmt,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return err.msg

    def add_rider(self, ride_id, rider_username):
        &#34;&#34;&#34;
            Called from the &#34;book seat&#34; button, add the user to the requested ride 

            Takes in the ride_id and username, adds entry into Riders table

            Returns True on success, False on failure 

            Parameters
            --------
            ride_id: an integer describing a unique ride 

            rider_username: currently logged in username 

        &#34;&#34;&#34;
        # First check that this rider is not already part of the specific ride 
        # Return False right away if they are 
        # Otherwise add entry 

        insert_stmt = (
            &#34;INSERT INTO Riders &#34;
            &#34;VALUES (%s, %s, %s, %s)&#34;
        )
        
        values = (
            ride_id, rider_username, &#39;PENDING&#39;, False
            )
        
        try:
            self.cursor.execute(insert_stmt,values)
            self.connection.commit()
            return (0, &#34;Updated ride with new rider&#34;)
        except ms.Error as err:
            # Code 1062 = failed insertion due to duplicate primary key
            if err.errno == 1062: return (1062,err.msg)

    def accept_ride(self, ride_id, user):
        &#34;&#34;&#34;
            Changes status of rider from PENDING-&gt;ACCEPTED
            Decrement seat count for the ride by 1 

            Parameters
            --------
            ride_id: an integer describing a unique ride 

            user: currently logged in username 

        &#34;&#34;&#34;
        # First check if the ride has seats left, return false right away if it doesn&#39;t

        query = (
            &#34;SELECT seats FROM MasterRides WHERE ride_id = %s &#34;
        )
        i = (ride_id,)
        self.cursor.execute(query,i)
        rows = self.cursor.fetchall()
        results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rows:
            results.append(dict(zip(headers,record)))
        
        results = results[0]
        if results[&#39;seats&#39;] &lt; 1:
            return (1, &#34;No space left in ride&#34;)

        update = (
            &#34;UPDATE Riders SET status = &#39;ACCEPTED&#39; WHERE ride_id = %s AND username = %s &#34;
        )

        values = (ride_id,user)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
        except ms.Error as err:
            return (1,err.msg)

        # Then UPDATE MasterRides by decrementing seat count for given ride_id 
        msg =  self.update_seatCount(ride_id)
        if msg == True: return (0,True)
        else: return (0,msg)

    def update_seatCount(self,ride_id):
        &#34;&#34;&#34;
            Decrements seat count for given ride id

            Parameters
            -----------
            ride_id: an integer describing a unique ride 
        &#34;&#34;&#34;

        update = (
            &#34;UPDATE MasterRides SET seats = seats-1 WHERE ride_id = %s &#34;
        )

        values = (ride_id,)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return err.msg
    
    def deny_ride(self, ride_id, user):
        &#34;&#34;&#34;
            Changes status of rider from PENDING-&gt;DENIED
            
            Parameters
            --------
            ride_id: an integer describing a unique ride 

            user: currently logged in username 
        &#34;&#34;&#34;

        update = (
            &#34;UPDATE Riders SET status = &#39;DENIED&#39; WHERE ride_id = %s AND username = %s &#34;
        )

        values = (ride_id,user)

        try:
            self.cursor.execute(update,values)
            self.connection.commit()
            return True
        except ms.Error as err:
            return (err.msg)
    
    def cleanup_rides(self):
        &#34;&#34;&#34;
        Removes all entries from MasterRides with trip start dates that occur before current date  


        &#34;&#34;&#34;
        queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
        queryB = (&#34;&#34;&#34;DELETE FROM MasterRides WHERE date &lt; curdate()&#34;&#34;&#34;)
        queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
        

        try:
            self.cursor.execute(queryA)
            self.cursor.execute(queryB)
            self.cursor.execute(queryC)
            self.connection.commit()
            return True
        except ms.Error as err:
            # Error code for attempting an unsafe update 
            if err.errno == 1175:
                return err.msg
            else: return err.msg

    def delete_riders(self):
        &#34;&#34;&#34;
        Removes all entries from Rides


        &#34;&#34;&#34;
        queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
        queryB = (&#34;&#34;&#34;DELETE FROM Riders&#34;&#34;&#34;)
        queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
        

        try:
            self.cursor.execute(queryA)
            self.cursor.execute(queryB)
            self.cursor.execute(queryC)
            self.connection.commit()
            return True
        except ms.Error as err:
            # Error code for attempting an unsafe update 
            if err.errno == 1175:
                return err.msg
            else: return err.msg


    
    def find_rides(self, params) -&gt; dict:
        &#34;&#34;&#34;
        Currently fetches all rides that occur on the specified date from the database
        Converts result into JSON format for easy processing in front end
        Returns an empty list if no rides found for the given date 

        Parameters
        --------

        params : dict
            The user-specified set of params on which to query for
        &#34;&#34;&#34;
        
        query = (
            &#34;&#34;&#34;SELECT *, 
                (
                3959 * acos (
                cos ( radians(%(fromLat)s) )
                * cos( radians( fromLat ) )
                * cos( radians( fromLng ) - radians(%(fromLng)s))
                + sin ( radians(%(fromLat)s) )
                * sin( radians( fromLat ) ))
                ) AS fromDistance,
                (
                3959 * acos (
                cos ( radians(%(toLat)s) )
                * cos( radians( toLat ) )
                * cos( radians( toLng ) - radians(%(toLng)s))
                + sin ( radians(%(toLat)s) )
                * sin( radians( toLat ) ))
                ) AS toDistance,
                DATEDIFF(date, %(date)s) AS timeDelta
            FROM MasterRides
            HAVING fromDistance &lt; 20 AND toDistance &lt; 20 AND timeDelta &gt;= 0
            ORDER BY timeDelta, fromDistance, toDistance
            LIMIT 0 , 20&#34;&#34;&#34;
        )
        
        try:
            self.cursor.execute(query, params)     # must pass params as tuples, hence (x,) format
            rows = self.cursor.fetchall()
        except ms.Error as err:
            return err.msg

        # Now convert SQL output into JSON for frontend 
        results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rows:
            results.append(dict(zip(headers,record)))
        

        return self.format_results(results)
    
    def format_results(self, results):
        &#34;&#34;&#34;
            Formats date time of SQL output 
        &#34;&#34;&#34;
        #separates datetime objects into date and time key values
        for result in results:
            dtime = result[&#39;date&#39;]
            result.pop(&#39;date&#39;)
            result[&#39;date&#39;] = dtime.strftime(&#39;%Y-%m-%d&#39;)
            result[&#39;time&#39;] = dtime.strftime(&#39;%H:%M:%S&#39;)
        
        return results

    def myrides(self, username):
        &#34;&#34;&#34;
            Displays all rides associated with given username 

            Parameters
            ----------
            username: the currently logged in username 
        &#34;&#34;&#34;
        # First try to grab all riders that are associated with current driver&#39;s rides 
        driver_query = (
            &#34;&#34;&#34;SELECT ride_id, username, status FROM Riders
                WHERE ride_id IN (
                SELECT ride_id FROM MasterRides
                WHERE driver_username = %s)
                AND is_driver = 0&#34;&#34;&#34;
        )

        value = (username,)
        
        try:
            self.cursor.execute(driver_query, value)     # must pass params as tuples, hence (x,) format
            driver_rows = self.cursor.fetchall()
        except:
            return &#34;Failed to execute my rides querys&#34;

        # Convert data into format for frontend
        driver_results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in driver_rows:
            driver_results.append(dict(zip(headers,record)))

        # Then execute the query for riders

        rider_query = (
            &#34;&#34;&#34;SELECT * FROM MasterRides 
                INNER JOIN Riders ON
                MasterRides.ride_id=Riders.ride_id
                WHERE Riders.username = %s
                ORDER by MasterRides.date&#34;&#34;&#34;
        )

        self.cursor.execute(rider_query, value)
        rider_rows = self.cursor.fetchall()
        
        # Else convert SQL output into dict for frontend 
        rider_results = []
        headers = [x[0] for x in self.cursor.description]   # grab column names

        for record in rider_rows:
            rider_results.append(dict(zip(headers,record)))
        
        return {&#39;my_passengers&#39;: driver_results, &#39;rides i am part of&#39;: rider_results}</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="DB_manager.Database.accept_ride"><code class="name flex">
<span>def <span class="ident">accept_ride</span></span>(<span>self, ride_id, user)</span>
</code></dt>
<dd>
<div class="desc"><p>Changes status of rider from PENDING-&gt;ACCEPTED
Decrement seat count for the ride by 1 </p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>ride_id</code></strong> :&ensp;<code>an integer describing a unique ride </code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>user</code></strong> :&ensp;<code>currently logged in username</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def accept_ride(self, ride_id, user):
    &#34;&#34;&#34;
        Changes status of rider from PENDING-&gt;ACCEPTED
        Decrement seat count for the ride by 1 

        Parameters
        --------
        ride_id: an integer describing a unique ride 

        user: currently logged in username 

    &#34;&#34;&#34;
    # First check if the ride has seats left, return false right away if it doesn&#39;t

    query = (
        &#34;SELECT seats FROM MasterRides WHERE ride_id = %s &#34;
    )
    i = (ride_id,)
    self.cursor.execute(query,i)
    rows = self.cursor.fetchall()
    results = []
    headers = [x[0] for x in self.cursor.description]   # grab column names

    for record in rows:
        results.append(dict(zip(headers,record)))
    
    results = results[0]
    if results[&#39;seats&#39;] &lt; 1:
        return (1, &#34;No space left in ride&#34;)

    update = (
        &#34;UPDATE Riders SET status = &#39;ACCEPTED&#39; WHERE ride_id = %s AND username = %s &#34;
    )

    values = (ride_id,user)

    try:
        self.cursor.execute(update,values)
        self.connection.commit()
    except ms.Error as err:
        return (1,err.msg)

    # Then UPDATE MasterRides by decrementing seat count for given ride_id 
    msg =  self.update_seatCount(ride_id)
    if msg == True: return (0,True)
    else: return (0,msg)</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.add_driver"><code class="name flex">
<span>def <span class="ident">add_driver</span></span>(<span>self, ride: Ride_manager.Ride) ‑> bool</span>
</code></dt>
<dd>
<div class="desc"><p>Adds the driver as a "user of the ride" to the secondary Riders table with following schema:</p>
<p>ride_id | username | status | is_driver </p>
<p>Returns True on success, False on failure. </p>
<h2 id="parameters">Parameters</h2>
<p>ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_driver(self, ride:Ride) -&gt; bool:
    &#34;&#34;&#34;
        Adds the driver as a &#34;user of the ride&#34; to the secondary Riders table with following schema:
        
        ride_id | username | status | is_driver 

        Returns True on success, False on failure. 

        Parameters
        -------- 
    
        ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.
    &#34;&#34;&#34;
    params = ride.getAll()
    id = ride.get_ride_id()
    insert_stmt = (
        &#34;INSERT INTO Riders &#34;
        &#34;VALUES (%s, %s, %s, %s)&#34;
    )
    
    values = (
        id, params[&#39;driver&#39;], &#39;ACCEPTED&#39;, True
        )
    
    # This catches improper insertions 
    try:
        self.cursor.execute(insert_stmt,values)
        self.connection.commit()
        return True
    except ms.Error as err:
        return err.msg</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.add_rider"><code class="name flex">
<span>def <span class="ident">add_rider</span></span>(<span>self, ride_id, rider_username)</span>
</code></dt>
<dd>
<div class="desc"><p>Called from the "book seat" button, add the user to the requested ride </p>
<p>Takes in the ride_id and username, adds entry into Riders table</p>
<p>Returns True on success, False on failure </p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>ride_id</code></strong> :&ensp;<code>an integer describing a unique ride </code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>rider_username</code></strong> :&ensp;<code>currently logged in username</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_rider(self, ride_id, rider_username):
    &#34;&#34;&#34;
        Called from the &#34;book seat&#34; button, add the user to the requested ride 

        Takes in the ride_id and username, adds entry into Riders table

        Returns True on success, False on failure 

        Parameters
        --------
        ride_id: an integer describing a unique ride 

        rider_username: currently logged in username 

    &#34;&#34;&#34;
    # First check that this rider is not already part of the specific ride 
    # Return False right away if they are 
    # Otherwise add entry 

    insert_stmt = (
        &#34;INSERT INTO Riders &#34;
        &#34;VALUES (%s, %s, %s, %s)&#34;
    )
    
    values = (
        ride_id, rider_username, &#39;PENDING&#39;, False
        )
    
    try:
        self.cursor.execute(insert_stmt,values)
        self.connection.commit()
        return (0, &#34;Updated ride with new rider&#34;)
    except ms.Error as err:
        # Code 1062 = failed insertion due to duplicate primary key
        if err.errno == 1062: return (1062,err.msg)</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.cleanup_rides"><code class="name flex">
<span>def <span class="ident">cleanup_rides</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Removes all entries from MasterRides with trip start dates that occur before current date</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cleanup_rides(self):
    &#34;&#34;&#34;
    Removes all entries from MasterRides with trip start dates that occur before current date  


    &#34;&#34;&#34;
    queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
    queryB = (&#34;&#34;&#34;DELETE FROM MasterRides WHERE date &lt; curdate()&#34;&#34;&#34;)
    queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
    

    try:
        self.cursor.execute(queryA)
        self.cursor.execute(queryB)
        self.cursor.execute(queryC)
        self.connection.commit()
        return True
    except ms.Error as err:
        # Error code for attempting an unsafe update 
        if err.errno == 1175:
            return err.msg
        else: return err.msg</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.connect_to_db"><code class="name flex">
<span>def <span class="ident">connect_to_db</span></span>(<span>self) ‑> str</span>
</code></dt>
<dd>
<div class="desc"><p>Uses supplied config file to connect to a mySQL database, initialize the cursor, and return the handle
for the connection to user </p>
<p>Returns a static message CONN_FAILURE on failure to establish connection</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def connect_to_db(self) -&gt; str:
    &#34;&#34;&#34;
    Uses supplied config file to connect to a mySQL database, initialize the cursor, and return the handle
    for the connection to user 

    Returns a static message CONN_FAILURE on failure to establish connection
    &#34;&#34;&#34;
    try:
        self.connection = ms.connect(**self.config) 
        self.cursor = self.connection.cursor()    
        return self.get_handle() 
    except:
        return CONN_FAILURE</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.create_ride"><code class="name flex">
<span>def <span class="ident">create_ride</span></span>(<span>self, ride: Ride_manager.Ride) ‑> bool</span>
</code></dt>
<dd>
<div class="desc"><p>Creates the specified ride and adds it to the MasterRides table in the backend DB</p>
<p>Returns True if ride was succesfully added, False if not </p>
<h2 id="parameters">Parameters</h2>
<p>ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_ride(self, ride:Ride) -&gt; bool:
    &#34;&#34;&#34;
    Creates the specified ride and adds it to the MasterRides table in the backend DB

    Returns True if ride was succesfully added, False if not 

    Parameters
    -------- 
    
    ride: A Ride object composed of parameters such as from/to locations, date, price, car, etc.

    &#34;&#34;&#34;

    params = ride.getAll()
    
    insert_stmt = (
        &#34;INSERT INTO MasterRides &#34;
        &#34;VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NULL, %s, %s)&#34;
    )
    
    values = (
        params[&#39;driver&#39;], params[&#39;from&#39;], params[&#39;to&#39;], params[&#39;fromLat&#39;], params[&#39;fromLng&#39;],
        params[&#39;make&#39;], params[&#39;plate&#39;], params[&#39;datetime&#39;], 
        params[&#39;price&#39;], params[&#39;seats&#39;], params[&#39;model&#39;], params[&#39;toLat&#39;], params[&#39;toLng&#39;]
        )
    
    # This catches improper insertions 
    try:
        self.cursor.execute(insert_stmt,values)
        id = self.cursor.lastrowid
        ride.set_ride_id(id)
        self.connection.commit()
        return True
        #GET RID OF THIS LINE AT 130
    except ms.Error as err:
        return err.msg</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.delete_riders"><code class="name flex">
<span>def <span class="ident">delete_riders</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Removes all entries from Rides</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def delete_riders(self):
    &#34;&#34;&#34;
    Removes all entries from Rides


    &#34;&#34;&#34;
    queryA = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 0&#34;&#34;&#34;)
    queryB = (&#34;&#34;&#34;DELETE FROM Riders&#34;&#34;&#34;)
    queryC = (&#34;&#34;&#34;SET SQL_SAFE_UPDATES = 1&#34;&#34;&#34;)
    

    try:
        self.cursor.execute(queryA)
        self.cursor.execute(queryB)
        self.cursor.execute(queryC)
        self.connection.commit()
        return True
    except ms.Error as err:
        # Error code for attempting an unsafe update 
        if err.errno == 1175:
            return err.msg
        else: return err.msg</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.deny_ride"><code class="name flex">
<span>def <span class="ident">deny_ride</span></span>(<span>self, ride_id, user)</span>
</code></dt>
<dd>
<div class="desc"><p>Changes status of rider from PENDING-&gt;DENIED</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>ride_id</code></strong> :&ensp;<code>an integer describing a unique ride </code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>user</code></strong> :&ensp;<code>currently logged in username</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deny_ride(self, ride_id, user):
    &#34;&#34;&#34;
        Changes status of rider from PENDING-&gt;DENIED
        
        Parameters
        --------
        ride_id: an integer describing a unique ride 

        user: currently logged in username 
    &#34;&#34;&#34;

    update = (
        &#34;UPDATE Riders SET status = &#39;DENIED&#39; WHERE ride_id = %s AND username = %s &#34;
    )

    values = (ride_id,user)

    try:
        self.cursor.execute(update,values)
        self.connection.commit()
        return True
    except ms.Error as err:
        return (err.msg)</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.find_rides"><code class="name flex">
<span>def <span class="ident">find_rides</span></span>(<span>self, params) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"><p>Currently fetches all rides that occur on the specified date from the database
Converts result into JSON format for easy processing in front end
Returns an empty list if no rides found for the given date </p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>params</code></strong> :&ensp;<code>dict</code></dt>
<dd>The user-specified set of params on which to query for</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def find_rides(self, params) -&gt; dict:
    &#34;&#34;&#34;
    Currently fetches all rides that occur on the specified date from the database
    Converts result into JSON format for easy processing in front end
    Returns an empty list if no rides found for the given date 

    Parameters
    --------

    params : dict
        The user-specified set of params on which to query for
    &#34;&#34;&#34;
    
    query = (
        &#34;&#34;&#34;SELECT *, 
            (
            3959 * acos (
            cos ( radians(%(fromLat)s) )
            * cos( radians( fromLat ) )
            * cos( radians( fromLng ) - radians(%(fromLng)s))
            + sin ( radians(%(fromLat)s) )
            * sin( radians( fromLat ) ))
            ) AS fromDistance,
            (
            3959 * acos (
            cos ( radians(%(toLat)s) )
            * cos( radians( toLat ) )
            * cos( radians( toLng ) - radians(%(toLng)s))
            + sin ( radians(%(toLat)s) )
            * sin( radians( toLat ) ))
            ) AS toDistance,
            DATEDIFF(date, %(date)s) AS timeDelta
        FROM MasterRides
        HAVING fromDistance &lt; 20 AND toDistance &lt; 20 AND timeDelta &gt;= 0
        ORDER BY timeDelta, fromDistance, toDistance
        LIMIT 0 , 20&#34;&#34;&#34;
    )
    
    try:
        self.cursor.execute(query, params)     # must pass params as tuples, hence (x,) format
        rows = self.cursor.fetchall()
    except ms.Error as err:
        return err.msg

    # Now convert SQL output into JSON for frontend 
    results = []
    headers = [x[0] for x in self.cursor.description]   # grab column names

    for record in rows:
        results.append(dict(zip(headers,record)))
    

    return self.format_results(results)</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.format_results"><code class="name flex">
<span>def <span class="ident">format_results</span></span>(<span>self, results)</span>
</code></dt>
<dd>
<div class="desc"><p>Formats date time of SQL output</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def format_results(self, results):
    &#34;&#34;&#34;
        Formats date time of SQL output 
    &#34;&#34;&#34;
    #separates datetime objects into date and time key values
    for result in results:
        dtime = result[&#39;date&#39;]
        result.pop(&#39;date&#39;)
        result[&#39;date&#39;] = dtime.strftime(&#39;%Y-%m-%d&#39;)
        result[&#39;time&#39;] = dtime.strftime(&#39;%H:%M:%S&#39;)
    
    return results</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.get_handle"><code class="name flex">
<span>def <span class="ident">get_handle</span></span>(<span>self) ‑> <module 'mysql.connector' from '/usr/local/lib/python3.9/site-packages/mysql/connector/__init__.pyc'></span>
</code></dt>
<dd>
<div class="desc"><p>Returns handle to the DB instance</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_handle(self) -&gt; ms:
    &#34;&#34;&#34;
    Returns handle to the DB instance 
    &#34;&#34;&#34;
    return self.connection</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.myrides"><code class="name flex">
<span>def <span class="ident">myrides</span></span>(<span>self, username)</span>
</code></dt>
<dd>
<div class="desc"><p>Displays all rides associated with given username </p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>username</code></strong> :&ensp;<code>the currently logged in username</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def myrides(self, username):
    &#34;&#34;&#34;
        Displays all rides associated with given username 

        Parameters
        ----------
        username: the currently logged in username 
    &#34;&#34;&#34;
    # First try to grab all riders that are associated with current driver&#39;s rides 
    driver_query = (
        &#34;&#34;&#34;SELECT ride_id, username, status FROM Riders
            WHERE ride_id IN (
            SELECT ride_id FROM MasterRides
            WHERE driver_username = %s)
            AND is_driver = 0&#34;&#34;&#34;
    )

    value = (username,)
    
    try:
        self.cursor.execute(driver_query, value)     # must pass params as tuples, hence (x,) format
        driver_rows = self.cursor.fetchall()
    except:
        return &#34;Failed to execute my rides querys&#34;

    # Convert data into format for frontend
    driver_results = []
    headers = [x[0] for x in self.cursor.description]   # grab column names

    for record in driver_rows:
        driver_results.append(dict(zip(headers,record)))

    # Then execute the query for riders

    rider_query = (
        &#34;&#34;&#34;SELECT * FROM MasterRides 
            INNER JOIN Riders ON
            MasterRides.ride_id=Riders.ride_id
            WHERE Riders.username = %s
            ORDER by MasterRides.date&#34;&#34;&#34;
    )

    self.cursor.execute(rider_query, value)
    rider_rows = self.cursor.fetchall()
    
    # Else convert SQL output into dict for frontend 
    rider_results = []
    headers = [x[0] for x in self.cursor.description]   # grab column names

    for record in rider_rows:
        rider_results.append(dict(zip(headers,record)))
    
    return {&#39;my_passengers&#39;: driver_results, &#39;rides i am part of&#39;: rider_results}</code></pre>
</details>
</dd>
<dt id="DB_manager.Database.update_seatCount"><code class="name flex">
<span>def <span class="ident">update_seatCount</span></span>(<span>self, ride_id)</span>
</code></dt>
<dd>
<div class="desc"><p>Decrements seat count for given ride id</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>ride_id</code></strong> :&ensp;<code>an integer describing a unique ride</code></dt>
<dd>&nbsp;</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update_seatCount(self,ride_id):
    &#34;&#34;&#34;
        Decrements seat count for given ride id

        Parameters
        -----------
        ride_id: an integer describing a unique ride 
    &#34;&#34;&#34;

    update = (
        &#34;UPDATE MasterRides SET seats = seats-1 WHERE ride_id = %s &#34;
    )

    values = (ride_id,)

    try:
        self.cursor.execute(update,values)
        self.connection.commit()
        return True
    except ms.Error as err:
        return err.msg</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="DB_manager.Database" href="#DB_manager.Database">Database</a></code></h4>
<ul class="two-column">
<li><code><a title="DB_manager.Database.accept_ride" href="#DB_manager.Database.accept_ride">accept_ride</a></code></li>
<li><code><a title="DB_manager.Database.add_driver" href="#DB_manager.Database.add_driver">add_driver</a></code></li>
<li><code><a title="DB_manager.Database.add_rider" href="#DB_manager.Database.add_rider">add_rider</a></code></li>
<li><code><a title="DB_manager.Database.cleanup_rides" href="#DB_manager.Database.cleanup_rides">cleanup_rides</a></code></li>
<li><code><a title="DB_manager.Database.connect_to_db" href="#DB_manager.Database.connect_to_db">connect_to_db</a></code></li>
<li><code><a title="DB_manager.Database.create_ride" href="#DB_manager.Database.create_ride">create_ride</a></code></li>
<li><code><a title="DB_manager.Database.delete_riders" href="#DB_manager.Database.delete_riders">delete_riders</a></code></li>
<li><code><a title="DB_manager.Database.deny_ride" href="#DB_manager.Database.deny_ride">deny_ride</a></code></li>
<li><code><a title="DB_manager.Database.find_rides" href="#DB_manager.Database.find_rides">find_rides</a></code></li>
<li><code><a title="DB_manager.Database.format_results" href="#DB_manager.Database.format_results">format_results</a></code></li>
<li><code><a title="DB_manager.Database.get_handle" href="#DB_manager.Database.get_handle">get_handle</a></code></li>
<li><code><a title="DB_manager.Database.myrides" href="#DB_manager.Database.myrides">myrides</a></code></li>
<li><code><a title="DB_manager.Database.update_seatCount" href="#DB_manager.Database.update_seatCount">update_seatCount</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>